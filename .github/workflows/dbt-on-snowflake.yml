name: dbt on Snowflake (dev)

on:
  push:
    branches: ["main"] # run on push to main
  workflow_dispatch: # allow manual runs from the Actions tab

env:
  DBT_PROJECT_NAME: dbt_snowflake
  DBT_TARGET: dev

jobs:
  deploy-and-build:
    runs-on: ubuntu-latest
    environment: dev # pull secrets from the 'dev' environment

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install CLI + dbt tooling
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade snowflake-cli dbt-core dbt-snowflake

      - name: Write Snowflake private key from secret
        run: |
          echo "${{ secrets.SNOWFLAKE_PRIVATE_KEY_B64 }}" | base64 -d > $HOME/sf_key.p8
          chmod 600 $HOME/sf_key.p8

      - name: Configure Snowflake CLI (connection 'ci')
        run: |
          mkdir -p ~/.snowflake
          cat > ~/.snowflake/config.toml <<'EOF'
          default_connection_name = "ci"
          [connections.ci]
          account = "${{ secrets.SNOWFLAKE_ACCOUNT }}"
          user = "${{ secrets.SNOWFLAKE_USER }}"
          role = "${{ secrets.SNOWFLAKE_ROLE }}"
          warehouse = "${{ secrets.SNOWFLAKE_WAREHOUSE }}"
          database = "${{ secrets.SNOWFLAKE_PROJECT_DB }}"
          schema = "${{ secrets.SNOWFLAKE_PROJECT_SCHEMA }}"
          authenticator = "SNOWFLAKE_JWT"
          private_key_path = "/home/runner/sf_key.p8"
          EOF
          chmod 0600 ~/.snowflake/config.toml

      # Optional but handy if the Dev database wasn't created yet
      - name: Ensure Dev database & schemas exist (idempotent)
        run: |
          snow sql -c ci -q "create database if not exists ANALYTICS_DEV;
                              create schema if not exists ANALYTICS_DEV.LANDING;
                              create schema if not exists ANALYTICS_DEV.BRONZE;
                              create schema if not exists ANALYTICS_DEV.SILVER;
                              create schema if not exists ANALYTICS_DEV.GOLD;"

      - name: Vendor dbt packages into the project object
        run: dbt deps

      - name: Deploy/Update dbt project object in Snowflake (Dev)
        run: snow dbt deploy "${{ env.DBT_PROJECT_NAME }}" --source . --profiles-dir . --force -c ci

      - name: Execute build inside Snowflake (Dev target)
        run: |
          # 'tag:boroughs+' selects seeds + bronze + silver + gold for your Boroughs example
          snow dbt execute -c ci "${{ env.DBT_PROJECT_NAME }}" build --target "${{ env.DBT_TARGET }}" --select "tag:boroughs+"
